name: ğŸ¯ Manual Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      
      version:
        description: 'Version to deploy (branch/tag/commit)'
        required: true
        default: 'main'
        type: string
      
      skip_tests:
        description: 'Skip tests and security checks'
        required: false
        default: false
        type: boolean
      
      force_deploy:
        description: 'Force deployment (ignore warnings)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  validate-inputs:
    name: ğŸ” Validate Deployment Request
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“ Log deployment parameters
        run: |
          echo "ğŸ¯ Manual Deployment Request"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Skip Tests: ${{ github.event.inputs.skip_tests }}"
          echo "Force Deploy: ${{ github.event.inputs.force_deploy }}"
          echo "Requested by: ${{ github.actor }}"

      - name: âš ï¸ Production deployment warning
        if: github.event.inputs.environment == 'production'
        run: |
          echo "âš ï¸ WARNING: Production deployment requested!"
          echo "ğŸ” Ensure all requirements are met:"
          echo "  âœ“ Code reviewed and approved"
          echo "  âœ“ Tests passing in staging"
          echo "  âœ“ Security scan completed"
          echo "  âœ“ Stakeholder approval obtained"

  conditional-tests:
    name: ğŸ§ª Conditional Testing
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: github.event.inputs.skip_tests == 'false'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: ğŸ“¦ Setup Node.js & pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Quick test suite
        run: |
          echo "ğŸ§ª Running essential tests..."
          # pnpm test:quick

      - name: ğŸ”’ Security check
        run: |
          echo "ğŸ”’ Running security checks..."
          # pnpm audit

  build-for-deployment:
    name: ğŸ—ï¸ Build for Deployment
    runs-on: ubuntu-latest
    needs: [validate-inputs]
    if: always() && !cancelled() && !failure()
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: ğŸ“¦ Setup Node.js & pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build applications
        run: |
          echo "ğŸ—ï¸ Building for ${{ github.event.inputs.environment }}..."
          cd apps/web && pnpm build
          echo "âœ… Build completed successfully!"

      - name: ğŸ“¦ Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: manual-deployment-${{ github.event.inputs.environment }}
          path: |
            apps/web/.next/
            apps/api/dist/
          retention-days: 30

  deploy:
    name: ğŸš€ Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    needs: [build-for-deployment]
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: ğŸ“¦ Download deployment artifacts
        uses: actions/download-artifact@v4
        with:
          name: manual-deployment-${{ github.event.inputs.environment }}
          path: ./deployment

      - name: ğŸš€ Deploy to ${{ github.event.inputs.environment }}
        run: |
          echo "ğŸš€ Starting deployment to ${{ github.event.inputs.environment }}..."
          echo "ğŸ“Š Deployment configuration:"
          echo "  - Environment: ${{ github.event.inputs.environment }}"
          echo "  - Version: ${{ github.event.inputs.version }}"
          echo "  - Timestamp: $(date)"
          echo "  - Deployer: ${{ github.actor }}"
          
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "ğŸ”´ PRODUCTION DEPLOYMENT"
            echo "ğŸ”„ Deploying to production servers..."
            # Production deployment logic here
          else
            echo "ğŸŸ¡ STAGING DEPLOYMENT"
            echo "ğŸ”„ Deploying to staging servers..."
            # Staging deployment logic here
          fi
          
          echo "âœ… Deployment completed successfully!"

      - name: ğŸ§ª Post-deployment verification
        run: |
          echo "ğŸ§ª Running post-deployment verification..."
          sleep 10  # Wait for services to start
          
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            # curl -f https://cipfaro-elearning.com/health
            echo "âœ… Production health check passed"
          else
            # curl -f https://staging.cipfaro-elearning.com/health
            echo "âœ… Staging health check passed"
          fi

  rollback-preparation:
    name: ğŸ”„ Prepare Rollback Plan
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.event.inputs.environment == 'production'
    
    steps:
      - name: ğŸ“‹ Create rollback documentation
        run: |
          echo "ğŸ”„ Rollback Plan for Deployment"
          echo "============================="
          echo "Deployment Details:"
          echo "- Environment: ${{ github.event.inputs.environment }}"
          echo "- Version Deployed: ${{ github.event.inputs.version }}"
          echo "- Deployment Time: $(date)"
          echo "- Deployed by: ${{ github.actor }}"
          echo ""
          echo "Rollback Instructions:"
          echo "1. Go to Actions tab"
          echo "2. Run 'Manual Deployment' workflow"
          echo "3. Select previous stable version"
          echo "4. Deploy to production"
          echo ""
          echo "Previous stable versions:"
          echo "- Check git tags for latest releases"
          echo "- Verify staging deployments"

      - name: ğŸ”” Notify deployment team
        run: |
          echo "ğŸ”” Notifying deployment team..."
          echo "ğŸ“§ Sending deployment notification..."
          echo "âœ… Team notified successfully!"

  notify-success:
    name: ğŸ‰ Deployment Success Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()
    
    steps:
      - name: ğŸ‰ Success notification
        run: |
          echo "ğŸ‰ Deployment Successful!"
          echo "========================"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Completed at: $(date)"

  notify-failure:
    name: ğŸš¨ Deployment Failure Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()
    
    steps:
      - name: ğŸš¨ Failure notification
        run: |
          echo "ğŸš¨ Deployment Failed!"
          echo "===================="
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Failed for: ${{ github.actor }}"
          echo "Failed at: $(date)"
          echo ""
          echo "ğŸ” Check the logs above for error details"
          echo "ğŸ”„ Consider rollback if this was a production deployment"