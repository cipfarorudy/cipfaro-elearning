name: ğŸ§ª CIPFARO V2 - Tests et SÃ©curitÃ©

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '9.6.0'

jobs:
  # Tests unitaires et d'intÃ©gration
  tests-unitaires:
    runs-on: ubuntu-latest
    name: ğŸ”¬ Tests Unitaires & IntÃ©gration
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ”¨ Build applications
      run: pnpm build
      
    - name: ğŸ§ª Run unit tests
      run: pnpm test:ci
      
    - name: ğŸ“Š Upload coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        
  # Tests end-to-end
  tests-e2e:
    runs-on: ubuntu-latest
    name: ğŸ­ Tests End-to-End
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ­ Install Playwright
      run: pnpm playwright:install
      
    - name: ğŸ”¨ Build applications
      run: pnpm build
      
    - name: ğŸ­ Run E2E tests
      run: pnpm test:e2e
      env:
        CI: true
        
    - name: ğŸ“¦ Upload E2E artifacts
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

  # Scan de sÃ©curitÃ©
  securite:
    runs-on: ubuntu-latest
    name: ğŸ”’ Scan de SÃ©curitÃ©
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ” ESLint Security Scan
      run: pnpm lint
      
    - name: ğŸ” Dependencies Audit
      run: pnpm audit --audit-level moderate
      
    - name: ğŸ”’ Security Scan complet
      run: pnpm security:scan
      
    - name: ğŸ“¦ Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report
        path: security-report.json
        retention-days: 90

  # Quality checks
  qualite:
    runs-on: ubuntu-latest
    name: âœ¨ ContrÃ´le QualitÃ©
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ” TypeScript check
      run: pnpm -r exec tsc --noEmit
      
    - name: ğŸ“ Code formatting
      run: npx prettier --check "**/*.{ts,tsx,js,jsx,json,md}"
      
    - name: ğŸ“Š Bundle analysis
      run: |
        pnpm build
        npx bundlesize

  # RÃ©sumÃ© des rÃ©sultats
  resultats:
    if: always()
    needs: [tests-unitaires, tests-e2e, securite, qualite]
    runs-on: ubuntu-latest
    name: ğŸ“‹ RÃ©sumÃ© des Tests
    
    steps:
    - name: ğŸ“Š Check results
      run: |
        echo "Tests unitaires: ${{ needs.tests-unitaires.result }}"
        echo "Tests E2E: ${{ needs.tests-e2e.result }}"
        echo "SÃ©curitÃ©: ${{ needs.securite.result }}"
        echo "QualitÃ©: ${{ needs.qualite.result }}"
        
        if [[ "${{ needs.tests-unitaires.result }}" == "success" && 
              "${{ needs.tests-e2e.result }}" == "success" && 
              "${{ needs.securite.result }}" == "success" && 
              "${{ needs.qualite.result }}" == "success" ]]; then
          echo "âœ… Tous les tests sont passÃ©s!"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Certains tests ont Ã©chouÃ©"
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: ğŸ‰ Success notification
      if: steps.check.outputs.status == 'success'
      run: |
        echo "ğŸ‰ Pipeline CIPFARO V2 - Tous les tests rÃ©ussis!"
        echo "âœ… Tests unitaires et d'intÃ©gration: OK"
        echo "âœ… Tests end-to-end: OK" 
        echo "âœ… Scan de sÃ©curitÃ©: OK"
        echo "âœ… ContrÃ´le qualitÃ©: OK"