name: ğŸš€ CIPFARO V2 - DÃ©ploiement ContrÃ´lÃ©

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de dÃ©ploiement'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: 'Version Ã  dÃ©ployer (ex: 1.2.3 ou latest)'
        required: true
        default: 'latest'
      run_tests:
        description: 'ExÃ©cuter les tests avant dÃ©ploiement'
        required: true
        type: boolean
        default: true
      security_scan:
        description: 'ExÃ©cuter le scan de sÃ©curitÃ©'
        required: true
        type: boolean
        default: true

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '9.6.0'

jobs:
  # Validation et prÃ©paration
  preparation:
    runs-on: ubuntu-latest
    name: ğŸ“‹ PrÃ©paration du DÃ©ploiement
    outputs:
      environment: ${{ steps.validate.outputs.environment }}
      version: ${{ steps.validate.outputs.version }}
      should-deploy: ${{ steps.validate.outputs.should-deploy }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âœ… Validation des paramÃ¨tres
      id: validate
      run: |
        echo "ğŸ” Validation des paramÃ¨tres de dÃ©ploiement"
        echo "Environnement: ${{ github.event.inputs.environment }}"
        echo "Version: ${{ github.event.inputs.version }}"
        echo "Tests: ${{ github.event.inputs.run_tests }}"
        echo "SÃ©curitÃ©: ${{ github.event.inputs.security_scan }}"
        
        # Validation de l'environnement
        if [[ "${{ github.event.inputs.environment }}" =~ ^(development|staging|production)$ ]]; then
          echo "âœ… Environnement valide"
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        else
          echo "âŒ Environnement invalide"
          exit 1
        fi
        
        # Validation de la version
        if [[ "${{ github.event.inputs.version }}" =~ ^(latest|[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          echo "âœ… Version valide"
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "âŒ Format de version invalide"
          exit 1
        fi
        
        # VÃ©rification spÃ©ciale pour la production
        if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
          echo "âš ï¸ DÃ‰PLOIEMENT EN PRODUCTION DÃ‰TECTÃ‰"
          echo "ğŸ”’ VÃ©rifications renforcÃ©es requises"
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        else
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        fi

  # Tests prÃ©-dÃ©ploiement (conditionnel)
  tests-pre-deploiement:
    if: github.event.inputs.run_tests == 'true'
    needs: preparation
    runs-on: ubuntu-latest
    name: ğŸ§ª Tests PrÃ©-DÃ©ploiement
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js & pnpm
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ”¨ Build
      run: pnpm build
      
    - name: ğŸ§ª Tests unitaires
      run: pnpm test:ci
      
    - name: ğŸ­ Tests E2E (staging/prod uniquement)
      if: github.event.inputs.environment != 'development'
      run: |
        pnpm playwright:install
        pnpm test:e2e

  # Scan de sÃ©curitÃ© (conditionnel)
  scan-securite:
    if: github.event.inputs.security_scan == 'true'
    needs: preparation
    runs-on: ubuntu-latest
    name: ğŸ”’ Scan de SÃ©curitÃ©
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js & pnpm
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ”’ Scan de sÃ©curitÃ© complet
      run: pnpm security:scan

  # Approbation manuelle pour la production
  approbation-production:
    if: needs.preparation.outputs.environment == 'production'
    needs: [preparation, tests-pre-deploiement, scan-securite]
    runs-on: ubuntu-latest
    name: âœ‹ Approbation Production
    environment: 
      name: production-approval
      url: https://cipfaro.com
    
    steps:
    - name: âš ï¸ Confirmation Production
      run: |
        echo "ğŸš¨ DÃ‰PLOIEMENT EN PRODUCTION"
        echo "ğŸ“‹ Environnement: production"
        echo "ğŸ·ï¸ Version: ${{ needs.preparation.outputs.version }}"
        echo "ğŸ‘¤ DÃ©clenchÃ© par: ${{ github.actor }}"
        echo "ğŸ•’ Timestamp: $(date -u)"
        echo ""
        echo "âš ï¸ Ce dÃ©ploiement affectera l'environnement de production"
        echo "âœ… Tous les tests ont Ã©tÃ© validÃ©s"
        echo "ğŸ”’ Scan de sÃ©curitÃ© approuvÃ©"
        echo ""
        echo "Cliquez sur 'Approve' pour continuer le dÃ©ploiement"

  # DÃ©ploiement
  deploiement:
    needs: [preparation, tests-pre-deploiement, scan-securite]
    if: |
      always() && 
      needs.preparation.result == 'success' && 
      (needs.tests-pre-deploiement.result == 'success' || needs.tests-pre-deploiement.result == 'skipped') &&
      (needs.scan-securite.result == 'success' || needs.scan-securite.result == 'skipped')
    runs-on: ubuntu-latest
    name: ğŸš€ DÃ©ploiement ${{ needs.preparation.outputs.environment }}
    environment: 
      name: ${{ needs.preparation.outputs.environment }}
      url: ${{ needs.preparation.outputs.environment == 'production' && 'https://cipfaro.com' || needs.preparation.outputs.environment == 'staging' && 'https://staging.cipfaro.com' || 'http://localhost:3000' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js & pnpm
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ”¨ Build pour ${{ needs.preparation.outputs.environment }}
      run: pnpm build
      env:
        NODE_ENV: ${{ needs.preparation.outputs.environment == 'production' && 'production' || 'staging' }}
        
    - name: ğŸš€ DÃ©ploiement Development
      if: needs.preparation.outputs.environment == 'development'
      run: |
        echo "ğŸ  DÃ©ploiement local/development"
        echo "âœ… Build terminÃ© - prÃªt pour dÃ©veloppement"
        
    - name: ğŸš€ DÃ©ploiement Staging
      if: needs.preparation.outputs.environment == 'staging'
      run: |
        echo "ğŸ§ª DÃ©ploiement staging"
        # Ici: commandes spÃ©cifiques au staging
        # Example: vercel deploy --prebuilt --target staging
        echo "âœ… DÃ©ployÃ© sur l'environnement de staging"
        
    - name: ğŸš€ DÃ©ploiement Production
      if: needs.preparation.outputs.environment == 'production'
      run: |
        echo "ğŸŒŸ DÃ©ploiement production"
        # Ici: commandes spÃ©cifiques Ã  la production
        # Example: vercel deploy --prebuilt --prod
        echo "âœ… DÃ©ployÃ© sur l'environnement de production"
        
    - name: ğŸ“ Log du dÃ©ploiement
      run: |
        echo "ğŸ“‹ DÃ‰PLOIEMENT CIPFARO V2 TERMINÃ‰"
        echo "================================"
        echo "ğŸŒ Environnement: ${{ needs.preparation.outputs.environment }}"
        echo "ğŸ·ï¸ Version: ${{ needs.preparation.outputs.version }}"
        echo "ğŸ‘¤ DÃ©ployÃ© par: ${{ github.actor }}"
        echo "ğŸ“… Date: $(date -u)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "âœ… Statut: SuccÃ¨s"

  # Notification de fin
  notification:
    if: always()
    needs: [preparation, deploiement]
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notification
    
    steps:
    - name: ğŸ‰ Notification de succÃ¨s
      if: needs.deploiement.result == 'success'
      run: |
        echo "ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI!"
        echo "ğŸŒ Environnement: ${{ needs.preparation.outputs.environment }}"
        echo "ğŸ·ï¸ Version: ${{ needs.preparation.outputs.version }}"
        echo "âœ… L'application CIPFARO V2 est maintenant dÃ©ployÃ©e"
        
    - name: âŒ Notification d'Ã©chec
      if: needs.deploiement.result == 'failure'
      run: |
        echo "âŒ Ã‰CHEC DU DÃ‰PLOIEMENT"
        echo "ğŸŒ Environnement: ${{ needs.preparation.outputs.environment }}"
        echo "ğŸ·ï¸ Version: ${{ needs.preparation.outputs.version }}"
        echo "ğŸ” VÃ©rifiez les logs pour plus de dÃ©tails"
        exit 1